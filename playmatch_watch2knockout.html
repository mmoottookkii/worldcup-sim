 
<!DOCTYPE html> 
<html lang="ja"> 
 
  <head> 
     
   <meta charset="UTF-8"> 
    
   <title>ガン消しサッカーシミュレーター</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0"> 

<style>



/* ページ全体 */
body {
  background-color: #1e1e1e; /* ダーク背景 */
  color: #f0f0f0; /* デフォルトテキストカラー（薄い白） */
}

html, body {
  overflow-x: hidden;
  margin: 0;
  padding: 0;
  max-width: 100vw;
}

* {
  box-sizing: border-box;
}

/* ======= 見出し ======= */
h1 {
  text-align: center;
}

/* ======= 上部コントロール ======= */
.top-controls {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 12px;
  width: 100%;
  margin: 0 auto 10px;
  background-color: #2c2c2c;
  border-bottom: 2px solid #444;
  padding: 8px 5px;
  border-radius: 0 0 10px 10px;
  color: #f0f0f0;
  flex-wrap: nowrap;
  overflow-x: auto;
}

/* ======= フィールド関連 ======= */
#soccer-field {
  position: relative;
  margin: 20px 0;
  width: 100%;
  height: 250px;
  background-color: #81C784;
  border: 3px solid white;
  border-radius: 20px;
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
  overflow: visible;
  z-index: 2;
}

#soccer-field::before {
  content: "";
  position: absolute;
  top: 0;
  left: 50%;
  width: 2px;
  height: 100%;
  background-color: white;
  transform: translateX(-50%);
  z-index: 3;
}

#soccer-field::after {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  width: 100px;
  height: 100px;
  border: 2px solid white;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  z-index:2;
}

/* ======= ゴールエリア ======= */
.goal-area {
  position: absolute;
  width: 60px;
  height: 150px;
  border: 2px solid white;
  background-color: rgba(255, 255, 255, 0.05);
  top: 50%;
  transform: translateY(-50%);
  z-index: 1;
}

#goal-left {
  left: 0px;
}

#goal-right {
  right: 0px;
}

/* ======= コンテナ関連 ======= */
#game-container,
.center-column

 {
  max-width: 100vw;
  overflow-x: hidden;
}

.center-column {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  flex: 1;
  width: 100%;
}

.side-column {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
  margin-top: -40px;
}

.middle-column {
  display: flex;
  flex-direction: row;
  witdh:100%;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  margin-top: -85px;
  z-index: 3;
}
       

/* ======= 画像・得点表示 ======= */

  .flag-container {
    position: relative;
    width: 90px;
    height: 90px; /* フレームに合わせて調整 */
  }

.flag-img {
  position: absolute;
  width: 80px;
  height: auto;
  margin: 5px;
  z-index: 2;
  cursor: pointer;
}

.flag-frame {
  position: absolute;
  top:-4px;
  left: -4px;
  width: 88px;
  height: auto;
  margin: 5px;
  z-index: 1;
}


.score-panel {
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 60px;
  font-weight: bold;
  text-align: center;
  margin-left: 20px;
  margin-right: 20px;
  gap: 10px; /* ← この値を調整すれば点数表示の間隔が広がる */
}

.scoreline-label {
  font-size: 20px;
  font-weight: bold;
  text-align: center;
}



/* ======= コントロール関連 ======= */
.controls-container {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 3px;
  margin-top: 1px;
  margin-bottom: -8px;
  z-index: 1000;
}

#position-box {
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
  gap: 10px;
  margin-top:10px;
  margin-bottom:30px;
  
  text-align: center;
}

#turn-counter {
  width: 250px;
  margin: 10px auto 20px;
  box-sizing: border-box;
  color: black;
  font-size: 30px;
  font-weight: bold;
  background-color: #fff;
  border: 3px solid #333;
  border-radius: 10px;
  padding: 10px 20px;
  box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.2);
  text-align: center;
  z-index: 10;
}

/* ======= ラジオボタン ======= */
.position-radio {
  appearance: none;
  -webkit-appearance: none;
  width: 40px;
  height: 40px;
  border: 4px solid #333;
  border-radius: 50%;
  background-color: #fff;
  position: relative;
  //cursor: pointer;
  z-index: 20;
}

.position-radio:checked {
  background-color: black;
  border-color: black;
}

.position-radio:checked::after {
  content: '';
  position: absolute;
  top: 8px;
  left: 8px;
  width: 16px;
  height: 16px;
  background-color: white;
  border-radius: 50%;
}

.position-radio:checked.special {
  background-color: orange;
  border-color: orange;
}

.position-radio:checked.special-red {
  background-color: red;
  border-color: red;
}

/* ======= ボタン類 ======= */
button {
  padding: 6px 10px;
  font-size: 13px;
  color: #f0f0f0;
  background-color: #333333;
  border: 1px solid #888;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.2s ease, box-shadow 0.2s ease;
  white-space: nowrap;
}

button:hover {
  background-color: #444444;
  box-shadow: 0 0 6px rgba(255, 215, 0, 0.4);
}

.btn-size {
  width: auto;
  height: auto;
  font-size: 13px;
  padding: 6px 10px;
}

/* 速度セレクト */
#speed-select {
  background-color: #222;
  color: #FFD700;
  border: 1px solid #555;
  padding: 4px 6px;
  font-size: 13px;
  border-radius: 5px;
  white-space: nowrap;
}


#reset-button {
      background-color: #f9d342;
      border: none;
      padding: 0.5rem 1rem;
      font-weight: bold;
      color: #203a43;
      border-radius: 5px;
      cursor: pointer;
 display:none;
}


/* ラベルも文字サイズ調整 */
.top-controls label {
  font-size: 13px;
  white-space: nowrap;
}


.btn-formblue, .btn-changeplayerblue, .btn-formred, .btn-changeplayerred {
  position: absolute;
  width: 150px;
  height: 30px;
  font-size: 13px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  color: white;
  padding: 1px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
  transition: all 0.2s ease-in-out;
  left: 0;
  top: 0;
}


#changeblue-button {
  z-index: 999; /* 背面だが表示される準備はある */
   width: 30px;
}

#setformblue-button {
  z-index: 1000; /* 通常時は前面 */
}

#changered-button {
  z-index: 899; /* 背面だが表示される準備はある */
   width: 30px;
}

#setformred-button {
  z-index: 900; /* 通常時は前面 */
}


.btn-formred {
  background-color: #f66; /* 薄めの赤 */
  opacity: 0.8;
}

.btn-formblue {
  background-color: #66aaff; /* 薄めの青 */
  opacity: 0.8;
}

.btn-changeplayerred {
  background-color: #f66; /* 薄めの赤 */
  opacity: 0.8;
}

.btn-changeplayerblue {
  background-color: #66aaff; /* 薄めの青 */
  opacity: 0.8;
}



.btn-formred:hover {
  background-color: #ff4d4d; /* ホバー時は少し濃く */
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  opacity: 1;
}

.btn-formblue:hover {
  background-color: #3399ff; /* ホバー時は少し濃く */
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
   opacity: 1;
}

.btn-changeplayerred:hover {
  background-color: #ff4d4d; /* ホバー時は少し濃く */
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  opacity: 1;
}

.btn-changeplayerblue:hover {
  background-color: #3399ff; /* ホバー時は少し濃く */
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
   opacity: 1;
}







#start-button,
#manual-start-button,
#fast-start-button {
  background-color: #81C784;
  color: #333;
  border: 2px solid #ddd;
  border-radius: 12px;
  padding: 12px 25px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
  margin: 0 5px;
  z-index: 30;
}

#start-button:hover,
#manual-start-button:hover,
#fast-start-button:hover {
  background-color: #f0f0f0;
  border-color: #bbb;
  box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
}

#start-button:active,
#manual-start-button:active,
#fast-start-button:active {
  background-color: #e0e0e0;
  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
}

/* ======= ログ・メッセージ ======= */
#game-log {
  white-space: pre-line;
  background-color: #ffffcc;
  padding: 10px;
  border: 1px solid #ccc;
  height: 250px;
  overflow-y: auto;
  width: 100%;
  text-align: center;
  margin-top: 160px; 
  color: black;
  z-index: 1;
}

.goal-message {
  position: absolute;
  font-size: 50px;
  font-weight: bold;
  color: red;
  display: none;
  background-color: rgba(255, 255, 255, 0.8);
  padding: 20px 40px;
  border: 4px solid red;
  border-radius: 20px;
  z-index: 10;
  text-align: center;
  white-space: nowrap;
  left: 50%;
  top: 30%;
  transform: translate(-50%, -50%);
}

#blue-goal-message {
  color: blue;
  border-color: blue;
}

#game-over-message {
  position: absolute;
  top: 35%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 40px;
  font-weight: bold;
  white-space: nowrap;
  color: black;
  display: none;
  background-color: rgba(255, 255, 255, 0.9);
  padding: 30px 50px;
  border: 5px solid black;
  border-radius: 20px;
  z-index: 20;
}

/* ======= ダイス関連 ======= */
.dice-row {
  width: 100%;
  display: flex;
  justify-content: space-between;
  box-sizing: border-box;
  padding-left: 0px;
  padding-right: 0px;

  margin: 10px 0;
  cursor: pointer;
}

.dice-track-container {
  width: 160px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 5px;
  color: black;
  font-size: 10px;
  font-weight: bold;
  background-color: #ffffff;
  border: 3px solid #333;
  border-radius: 10px;
  box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.2);
  padding: 5px;
  box-sizing: border-box;
}

.dice-block {
  width: 100%;
  background-color: rgba(255, 255, 255, 0.6);
  border: 2px solid #ccc;
  border-radius: 8px;
  padding: 5px 10px;
  box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.1);
  text-align: center;
}

.dice-label {
  font-size: 10px;
}

.dice-track {
  width: 100%;
  height: 14px;
  font-size: 14px;
  word-wrap: break-word;
  user-select: none;
  white-space: pre-line;
  background: linear-gradient(to right, #ff6666 0%, #ffcccc 100%);
  border-radius: 5px;
  overflow: hidden;
  position: relative;
}

.blue .dice-track {
  background: linear-gradient(to right, #6699ff 0%, #cce0ff 100%);
}

.dice-square {
  width: 50px;
  height: 50px;
  background-color: white;
  border: 1px solid black;
  border-radius: 10px;
  box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.2);
  position: relative;
  transform-style: preserve-3d;
}

@keyframes rotateY {
  0% { transform: rotateY(0deg); }
  100% { transform: rotateY(360deg); }
}

.dice-active {
  animation: rotateY 0.5s linear;
  animation-fill-mode: forwards;
}

/* 色付きダイス */
.d-RedA { background-color: blue; }
.d-RedB { background-color: white; }
.d-RedC { background-color: red; }
.d-BlueA { background-color: yellow; }
.d-BlueB { background-color: blue; }
.d-BlueC { background-color: green; }

/* ======= 補助表示 ======= */
.dot {
  width: 30px;
  height: 30px;
  background-color: white;
  border-radius: 50%;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  border: 2px solid red;
  box-sizing: border-box;
}

.dot::before,
.dot::after {
  content: "";
  position: absolute;
  width: 4px;
  height: 4px;
  background-color: red;
  border-radius: 50%;
  top: 7px;
}

.dot::before {
  left: 6px;  /* 左目 */
}

.dot::after {
  right: 6px; /* 右目 */
}

.dot span {
  position: absolute;
  width: 12px;
  height: 6px;
  border-bottom: 2px solid red;
  border-radius: 0 0 8px 8px;
  bottom: 5px;
  left: 50%;
  transform: translateX(-50%);
}



.attack-label {
  position: absolute;
  top: -25px;
  left: 50%;
  transform: translateX(-50%);
  color: black;
  font-size: 13px;
  font-weight: bold;
  pointer-events: none;
}

.fraction-label {
  position: absolute;
  bottom: -30px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 14px;
  color: white;
  //font-weight: bold;
  pointer-events: none;
  white-space: nowrap;

}

@media screen and (max-width: 768px) {

  .game-container {
    width: 100%;
    overflow-x: hidden;
  }

  .side-column {
    width: 100%;
    overflow-x: visible;
  }

.dice-row {
    //flex-wrap: wrap;
    //justify-content: center;
  }

  .top-controls {
    flex-direction: row;
    align-items: center;

  }

  .controls-container {
    flex-direction: column;
    gap: 10px;
  }

  .center-column {
    max-width: 100%;
    padding: 0px;
  }

  .side-column {
    max-width: 100%;
  }


  #soccer-field {
    width: 110vw;
    max-width: none;
  }
}



</style> 
 
 </head> 

 <body>
    <h1><audio id="anthem-player" src="" type="audio/mp3"></audio></h1>

    <div class="top-controls">
        <label for="speed-select">速度:</label>
        <select id="speed-select">
            <option value="1">1倍</option>
            <option value="0.5">0.5倍</option>
            <option value="2">2倍</option>
        </select>
        <button type="reset" id="reset-button" class="btn-size">戻る</button>
       <button id="mute-toggle" style="font-size: 10px;">音声OFF</button>
    </div>

    <div id="game-container">
        <div class="center-column">
<div class="controls-container">
  <div style="display: flex; flex-direction: row; justify-content: space-between; align-items: center; gap: 10px;">
    
    <!-- 赤チーム -->
    <div class="flag-container">
      <img id="red-flag-icon" src="flagpng/franceicon.png" class="flag-img" alt="Red Flag">
      <img src="flagpng/frame.png" class="flag-frame">
    </div>

    <!-- スコア -->
    <div class="score-panel">
      <div id="red-score">0</div>
      <div style="text-align: center;">
        <div class="scoreline-label">―</div>
      </div>
      <div id="blue-score">0</div>
    </div>

    <!-- 青チーム -->
    <div class="flag-container">
      <img src="flagpng/frame.png" class="flag-frame">
      <img id="blue-flag-icon" src="flagpng/brazilicon.png" class="flag-img" alt="Blue Flag">
    </div>
  </div>
</div>

            <div id="soccer-field">
                <div class="center-line"></div>
                <div class="goal-area" id="goal-left"></div>
                <div class="goal-area" id="goal-right"></div>

                <div id="turn-counter">試合時間: 0</div>

                <div id="position-box">
                    <label><input type="radio" name="position" value="-2" class="position-radio" disabled>-2</label>
                    <label><input type="radio" name="position" value="-1" class="position-radio" disabled>-1</label>
                    <label><input type="radio" name="position" value="0" class="position-radio" disabled checked>0</label>
                    <label><input type="radio" name="position" value="1" class="position-radio" disabled>1</label>
                    <label><input type="radio" name="position" value="2" class="position-radio" disabled>2</label>
                </div>

                <div style="display: flex; gap: 10px; justify-content: center; margin-top:270px;"   z-index: 5;>
                    <button id="start-button">自動</button>
                    <button id="fast-start-button">高速</button>
                    <button id="manual-start-button">手動</button>
                </div>
            </div>

            <div class="middle-column"id="field-row">
            
                    <!-- 左側 -->
                    <div class="side-column" id="left-column">
                        <div id="red-team-country" class="team-country-label"></div>
                        <div id="flag-container1"></div>
                        <div class="dice-row"id="red-dice-row">
                            <div class="dice-square d-Red d-RedC">
                                <span class="attack-label">守</span>
                                <div class="fraction-label redCcounter"></div>
                            </div>
                            <div class="dice-square d-Red d-RedB">
                                <span class="attack-label">中</span>
                                <div class="fraction-label redBcounter"></div>
                            </div>
                            <div class="dice-square d-Red d-RedA">
                                <span class="attack-label">攻</span>
                                <div class="fraction-label redAcounter"></div>
                            </div>
                        </div>
                        <div class="dice-track-container red">
                            <div class="dice-block">
                                <div class="dice-label">攻撃力</div>
                                <div id="red-dice-track-a" class="dice-track"></div>
                            </div>
                            <div class="dice-block">
                                <div class="dice-label">保持力</div>
                                <div id="red-dice-track-b" class="dice-track"></div>
                            </div>
                            <div class="dice-block">
                                <div class="dice-label">守備力</div>
                                <div id="red-dice-track-c" class="dice-track"></div>
                            </div>
                         </div>
                            <div style=" position: relative; width:155px; margin-top: -170px;">
  
                               <button type="setformation" id="changered-button" class="btn-changeplayerred">交</button>
                               <button type="setformation" id="setformred-button" class="btn-formred">選手・配置変更</button>
                            </div>

                        </div>

                    <!-- 中央（空） -->
                    <div style="text-align: center;"></div>

                    <!-- 右側 -->
                    <div class="side-column"id="right-column">
                        <div id="blue-team-country" class="team-country-label"></div>
                        <div id="flag-container2"></div>
                        <div class="dice-row"id="blue-dice-row">
                            <div class="dice-square d-Blue d-BlueA">
                                <span class="attack-label">攻</span>
                                <div class="fraction-label blueAcounter"></div>
                            </div>
                            <div class="dice-square d-Blue d-BlueB">
                                <span class="attack-label">中</span>
                                <div class="fraction-label blueBcounter"></div>
                            </div>
                            <div class="dice-square d-Blue d-BlueC">
                                <span class="attack-label">守</span>
                                <div class="fraction-label blueCcounter"></div>
                            </div>
                        </div>
                        <div class="dice-track-container blue">
                            <div class="dice-block">
                                <div class="dice-label">攻撃力</div>
                                <div id="blue-dice-track-a" class="dice-track"></div>
                            </div>
                            <div class="dice-block">
                                <div class="dice-label">保持力</div>
                                <div id="blue-dice-track-b" class="dice-track"></div>
                            </div>
                            <div class="dice-block">
                                <div class="dice-label">守備力</div>
                                <div id="blue-dice-track-c" class="dice-track"></div>
                            </div>
                        </div>
                           <div style="position: relative; width:155px; margin-top: -170px;">
                             <button type="setformation" id="changeblue-button" class="btn-changeplayerblue">交</button>
                             <button type="setformation" id="setformblue-button" class="btn-formblue">選手・配置変更</button>
                           </div>

                    </div>               
            </div>

            <div id="game-log"></div>
        </div>
    </div>

    <!-- ゴール・終了メッセージ -->
    <div id="red-goal-message" class="goal-message">ゴール！</div>
    <div id="blue-goal-message" class="goal-message">ゴール！</div>

    <div id="game-over-message">試合終了！</div>

    <!-- 延長戦・PKボタン -->
    <button id="extension-button" style="position: absolute; top: 20px; right: 20px; display: none; padding: 5px 10px; font-size: 20px; background-color: #f9d342;
      color: #203a43;">
        延長戦突入！
    </button>
    <button id="pk-button" style="display: none; position: fixed; top: 20px; right: 20px; z-index: 1000; font-size: 20px; background-color: #f9d342;
      color: #203a43;" onclick="enterPK()">
        PK戦突入
    </button>

<!-- モーダル風div -->
<div id="changeModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999;">
 
  <iframe id="changeFrame" src="" style="width:100%; height:100%; border:none;"></iframe>
</div>

<div id="changeModal2" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999;">
 
  <iframe id="changeFrame2" src="" style="width:100%; height:100%; border:none;"></iframe>
</div>

</body>
      


 <script>


  // グローバル変数宣言

   let franceColors = [];
   let brazilColors = [];
   let franceIndex = 0;
   let brazilIndex = 0;


    let position = 0;// 現在の位置
    let redScore = 0;
    let blueScore = 0;
    let turn = 0;
    let maxTurns =90;
    let gameInterval;
    let gameLogs = []; // ← グローバルでログ配列を保持
    let isPlaying = false;  // 手動ボタン連打時のロック
    let isFastMode = false;   
    let isFirstHalfEnded = false;
    let isSecondHalfStarted = false;
    let isSideSwapped = false;
    let isExtension = false;// 延長戦フラグ
    let lastPosition = 0;
    let counterMode = null; // 特殊モードの宣言
    let tenseMode = null;  // 特殊モードの宣言
    let backattackMode = null; // 特殊モードの宣言
    let backattackfail = null;
    let isPK = false; // PK戦フラグ
    let bgmAudio = null; // BGM用Audioをグローバルに持たせる
    let isBgmPlaying = false;
    let isMuted = false;
    let allSE = []; // 効果音 Audio インスタンスを記録
    let isPaused = false;  //選手交代フラグ（初期は false）


// チームの能力確率の設定


   let redTeamId = localStorage.getItem("team-red");
   let blueTeamId = localStorage.getItem("team-blue");

  const redTeamJP = localStorage.getItem("team-red-jp") || "赤チーム国名";
  const blueTeamJP = localStorage.getItem("team-blue-jp") || "青チーム国名";


  console.log("チームRED:", redTeamId);  // 例: "japan"
  console.log("チームBLUE:", blueTeamId); // 例: "brazil"

   var redtrack_a_value = 0;
   var redtrack_b_value = 0;
   var redtrack_c_value = 0;
   var bluetrack_a_value = 0;
   var bluetrack_b_value = 0;
   var bluetrack_c_value = 0;


// 頻度調整   
   
   var RedAP, RedBP, RedCP, BlueAP, BlueBP, BlueCP;
   let redDiceProbabilities, blueDiceProbabilities;

// 頻度調整関数
  function updateProbabilities() {
  RedAP = 0.00075 * redtrack_a_value;
  RedBP = 0.00075 * redtrack_b_value;
  RedCP = 0.00075 * redtrack_c_value;
  BlueAP = 0.00075 * bluetrack_a_value;
  BlueBP = 0.00075 * bluetrack_b_value;
  BlueCP = 0.00075 * bluetrack_c_value;

  redDiceProbabilities = [RedAP, RedBP, RedCP];
  blueDiceProbabilities = [BlueAP, BlueBP, BlueCP];
}


  // 国名を左・右のデータバーラベルに表示

  // 「攻撃力」「保持力」「守備力」ラベルを国名付きに更新
  const redDiceLabels = document.querySelectorAll("#left-column .dice-label");
  const blueDiceLabels = document.querySelectorAll("#right-column .dice-label");

  const labelNames = ["攻撃力", "保持力", "守備力"];

  redDiceLabels.forEach((label, index) => {
    label.textContent = `${redTeamJP}${labelNames[index]}`;
  });

  blueDiceLabels.forEach((label, index) => {
    label.textContent = `${blueTeamJP}${labelNames[index]}`;
  });



  // チームIDに対応する画像アイコンを生成
  const redFlagImg = document.getElementById("red-flag-icon");
  const blueFlagImg = document.getElementById("blue-flag-icon");
  const anthemPlayer = document.getElementById("anthem-player");

  redFlagImg.src = `flagpng/${redTeamId}icon.png`;
  blueFlagImg.src = `flagpng/${blueTeamId}icon.png`;


  // 国歌再生関数
  let currentPlayingTeam = null; // 今再生中のチーム名

function playAnthem(teamId) {
  const player = document.getElementById("anthem-player");

  // 音量を設定（0.0 ～ 1.0）
  player.volume = 0.6;  // ここで音量調整（50%に設定）

  // 同じ国をもう一度クリック → 停止
  if (currentPlayingTeam === teamId && !player.paused) {
    player.pause();
    player.currentTime = 0;
    currentPlayingTeam = null;
    return;
  }

  // 違う国をクリック → 別の国歌に切り替えて再生
  player.src = `anthem/${teamId}.mp3`;
  player.play().then(() => {
    currentPlayingTeam = teamId;
  }).catch((e) => {
    console.log("再生エラー:", e);
    currentPlayingTeam = null;
  });
}



  // 国旗クリック時に国歌再生
  redFlagImg.addEventListener("click", () => playAnthem(redTeamId));
  blueFlagImg.addEventListener("click", () => playAnthem(blueTeamId));



  // BGM効果音再生関数
function playBGM() {
  if (isBgmPlaying) return; // ★すでに再生中なら何もしない

  bgmAudio = new Audio('bgm/stadiumcrowdcut.mp3');
  bgmAudio.loop = true; // ループ再生（任意）
  bgmAudio.volume = 0.2;
  bgmAudio.muted = isMuted; // ←追加
  bgmAudio.play();

  isBgmPlaying = true;

  // エラーや終了時に状態を戻す（任意）
  bgmAudio.onended = () => { isBgmPlaying = false; };
  bgmAudio.onerror = () => { isBgmPlaying = false; };
}


function playYell() {
  const se = new Audio('bgm/stadiumyell.mp3');
  se.volume = 0.3; // 効果音はやや大きめ
  se.muted = isMuted; // ←追加
  se.play();
  allSE.push(se); // リストに追加
}

function playGamesetYell() {
  const se = new Audio('bgm/gamesetyell.mp3');
  se.volume = 0.5; // 効果音はやや大きめ
  se.muted = isMuted; // ←追加
  se.play();
  allSE.push(se); // リストに追加
}

function playGoalSE() {
  const se = new Audio('bgm/goalshout.mp3');
  se.volume = 0.4; // 効果音はやや大きめ
  se.muted = isMuted; // ←追加
  se.play();
  allSE.push(se); // リストに追加
}



 // ミュートボタンクリック
document.getElementById("mute-toggle").addEventListener("click", () => {
  isMuted = !isMuted;

  // anthem-player
  const anthemPlayer = document.getElementById("anthem-player");
  anthemPlayer.muted = isMuted;

  // BGM
  if (bgmAudio) {
    bgmAudio.muted = isMuted;
  }

  // すでに再生中の効果音SE
  allSE.forEach(se => {
    se.muted = isMuted;
  });

  // ボタンのアイコン更新
  document.getElementById("mute-toggle").textContent = isMuted ? "音声OFF" : "音声ON";
});



// GameDBからteamcolorを取得
function loadTeamColors(teamId) {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open("GameDB");
    request.onerror = () => reject("DB接続エラー");
    request.onsuccess = () => {
      const db = request.result;
      const tx = db.transaction("teamcolor", "readonly");
      const store = tx.objectStore("teamcolor");
      const index = store.index("teamId");
      const colors = [];
      const getRequest = index.openCursor(IDBKeyRange.only(teamId));
      getRequest.onsuccess = function (event) {
        const cursor = event.target.result;
        if (cursor) {
          const { color1, color2, color3 } = cursor.value;
          colors.push([color1, color2, color3]);
          cursor.continue();
        } else {
          resolve(colors);
        }
      };
      getRequest.onerror = () => reject("データ取得失敗");
    };
  });
}


// GameDBからformationsストアの能力値を取得
function loadFormationValues(teamId) {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open("GameDB");
    request.onerror = () => reject("DB接続エラー");
    request.onsuccess = () => {
      const db = request.result;
      const tx = db.transaction("formations", "readonly");
      const store = tx.objectStore("formations");
      const index = store.index("teamId");
      const getRequest = index.get(teamId);
      getRequest.onsuccess = () => {
        if (getRequest.result) {
          const { attack, midfield, defence } = getRequest.result;
          resolve({ attack, midfield, defence });
        } else {
          reject("チームのformationデータが見つかりません");
        }
      };
      getRequest.onerror = () => reject("データ取得失敗");
    };
  });
}


// サイコロ背景色にユニフォーム色を適用する関数
function applyColors(team, index) {
  const [c1, c2, c3] = (team === redTeamId ? franceColors : brazilColors)[index];
  if (team === redTeamId) {
    document.querySelector(".d-RedA").style.backgroundColor = c1;
    document.querySelector(".d-RedB").style.backgroundColor = c2;
    document.querySelector(".d-RedC").style.backgroundColor = c3;
  } else if (team === blueTeamId) {
    document.querySelector(".d-BlueA").style.backgroundColor = c1;
    document.querySelector(".d-BlueB").style.backgroundColor = c2;
    document.querySelector(".d-BlueC").style.backgroundColor = c3;
  }
}




// ページ読み込み初期化処理非同期

window.addEventListener("DOMContentLoaded", async () => {

 try {

    // 試合進行状態をlocalStorageから復元

     // 先にログを復元
     const savedLogs = localStorage.getItem("match_logs");
     if (savedLogs !== null) {
     gameLogs = JSON.parse(savedLogs);
     const logBox = document.getElementById('game-log');
     logBox.innerHTML = gameLogs.map(line => line.replace(/\n/g, "<br>")).join("");
     logBox.scrollTop = logBox.scrollHeight;
      }

    const savedFirstHalfEnded = localStorage.getItem("match_isFirstHalfEnded");
    if (savedFirstHalfEnded !== null) isFirstHalfEnded = savedFirstHalfEnded === "true";
    const savedSideSwapped = localStorage.getItem("match_isSideSwapped");
    if (savedSideSwapped !== null) isSideSwapped = savedSideSwapped === "true";

    const savedTurn = localStorage.getItem("match_turn");
    const savedRedScore = localStorage.getItem("match_redScore");
    const savedBlueScore = localStorage.getItem("match_blueScore");

    const savedSecondHalf = localStorage.getItem("match_isSecondHalfStarted");
    const savedExtension = localStorage.getItem("match_isExtension");

    if (savedTurn !== null) turn = parseInt(savedTurn, 10);
    if (savedRedScore !== null) redScore = parseInt(savedRedScore, 10);
    if (savedBlueScore !== null) blueScore = parseInt(savedBlueScore, 10);

    if (savedSecondHalf !== null) isSecondHalfStarted = savedSecondHalf === "true";
    if (savedExtension !== null) isExtension = savedExtension === "true";


    // サイコロ色データ読み込み
    franceColors = await loadTeamColors(redTeamId);
    brazilColors = await loadTeamColors(blueTeamId);
    applyColors(redTeamId, franceIndex);
    applyColors(blueTeamId, brazilIndex);


    // 能力データ読み込み

let redFormation = await loadFormationValues(redTeamId);
let blueFormation = await loadFormationValues(blueTeamId);

// localStorageの更新がある場合はそれを上書き適用
const redAtkLS = localStorage.getItem("formation_red_atk");
const redMidLS = localStorage.getItem("formation_red_mid");
const redDefLS = localStorage.getItem("formation_red_def");

const blueAtkLS = localStorage.getItem("formation_blue_atk");
const blueMidLS = localStorage.getItem("formation_blue_mid");
const blueDefLS = localStorage.getItem("formation_blue_def");

if (redAtkLS !== null && redMidLS !== null && redDefLS !== null) {
  redFormation.attack   = parseFloat(redAtkLS);
  redFormation.midfield = parseFloat(redMidLS);
  redFormation.defence  = parseFloat(redDefLS);
}

if (blueAtkLS !== null && blueMidLS !== null && blueDefLS !== null) {
  blueFormation.attack   = parseFloat(blueAtkLS);
  blueFormation.midfield = parseFloat(blueMidLS);
  blueFormation.defence  = parseFloat(blueDefLS);
}

     // 能力値代入
    redtrack_a_value = redFormation.attack;
    redtrack_b_value = redFormation.midfield;
    redtrack_c_value = redFormation.defence;
    bluetrack_a_value = blueFormation.attack;
    bluetrack_b_value = blueFormation.midfield;
    bluetrack_c_value = blueFormation.defence;


// フォーメーション変更による一時的な能力値の削除(保留中)
//localStorage.removeItem("formation_red_atk");
//localStorage.removeItem("formation_red_mid");
//localStorage.removeItem("formation_red_def");

//localStorage.removeItem("formation_blue_atk");
//localStorage.removeItem("formation_blue_mid");
//localStorage.removeItem("formation_blue_def");



    // 頻度再計算
    updateProbabilities();

    // 確率データバー表示
    renderRedDiceTracks();
    renderBlueDiceTracks();

   // スコアボード更新
    document.getElementById('red-score').textContent = redScore;
    document.getElementById('blue-score').textContent = blueScore;

   // 陣地反転をするかしないか判別更新
    if (isSideSwapped) {
    swapSideColumnsAndReorderDice();  // ← 左右を再入れ替え
    reversePositionRadios();          // ← ラジオボタンも反転
     }


    // サイコロ色の切り替えクリックイベント
    document.querySelectorAll(".d-Red").forEach(el => {
      el.addEventListener("click", () => {
        franceIndex = (franceIndex + 1) % franceColors.length;
        applyColors(redTeamId, franceIndex);
      });
    });

    document.querySelectorAll(".d-Blue").forEach(el => {
      el.addEventListener("click", () => {
        brazilIndex = (brazilIndex + 1) % brazilColors.length;
        applyColors(blueTeamId, brazilIndex);
      });
    });

  } catch (e) {
    console.error("初期化失敗:", e);
  }

updateTurnCounter(); 

});




// 選手交代モーダルウィンドウを開いたとき関数

function openChangeModal(teamRole) {
  isPaused = true; // 試合を一時停止
  const teamId = teamRole === "red" ? redTeamId : blueTeamId;
  localStorage.setItem("formteamId", teamId);
  localStorage.setItem("formteamRole", teamRole);

  const modal = document.getElementById("changeModal");
  const iframe = document.getElementById("changeFrame");

  // 延長戦フラグ isExtension（親側で既に定義済み）を使用
  iframe.onload = () => {
    iframe.contentWindow.postMessage({ type: "extensionFlag", isExtension: isExtension }, "*");
  };

  iframe.src = "change_player.html"; // ページを再読み込み（onload を確実に発火させるため）
  modal.style.display = "block";
}

// 選手配置変更モーダルウィンドウを開いたとき関数
function openChangeModal2(teamRole) {
  const teamId = teamRole === "red" ? redTeamId : blueTeamId;
  localStorage.setItem("formteamId", teamId);
  localStorage.setItem("formteamRole", teamRole);

  const modal = document.getElementById("changeModal2");
  const iframe = document.getElementById("changeFrame2");
  iframe.src = "formation_select1.html";  // ← 別ページを埋め込む
  modal.style.display = "block";
}


// 選手交代モーダルウィンドウを閉じたとき関数
function closeChangeModal() {
  document.getElementById("changeModal").style.display = "none";

  // 最新の能力値を読み込み・再代入
  const redAtk = localStorage.getItem("formation_red_atk");
  const redMid = localStorage.getItem("formation_red_mid");
  const redDef = localStorage.getItem("formation_red_def");

  const blueAtk = localStorage.getItem("formation_blue_atk");
  const blueMid = localStorage.getItem("formation_blue_mid");
  const blueDef = localStorage.getItem("formation_blue_def");

  if (redAtk && redMid && redDef) {
    redtrack_a_value = parseFloat(redAtk);
    redtrack_b_value = parseFloat(redMid);
    redtrack_c_value = parseFloat(redDef);
  }

  if (blueAtk && blueMid && blueDef) {
    bluetrack_a_value = parseFloat(blueAtk);
    bluetrack_b_value = parseFloat(blueMid);
    bluetrack_c_value = parseFloat(blueDef);
  }

  updateProbabilities();       // 再計算
  renderRedDiceTracks();       // 表示も更新
  renderBlueDiceTracks();

  isPaused = false;  // 試合を再開
}

// 選手配置変更モーダルウィンドウを閉じたとき関数
function closeChangeModal2() {
  document.getElementById("changeModal2").style.display = "none";

  // 最新の能力値を読み込み・再代入
  const redAtk = localStorage.getItem("formation_red_atk");
  const redMid = localStorage.getItem("formation_red_mid");
  const redDef = localStorage.getItem("formation_red_def");

  const blueAtk = localStorage.getItem("formation_blue_atk");
  const blueMid = localStorage.getItem("formation_blue_mid");
  const blueDef = localStorage.getItem("formation_blue_def");

  if (redAtk && redMid && redDef) {
    redtrack_a_value = parseFloat(redAtk);
    redtrack_b_value = parseFloat(redMid);
    redtrack_c_value = parseFloat(redDef);
  }

  if (blueAtk && blueMid && blueDef) {
    bluetrack_a_value = parseFloat(blueAtk);
    bluetrack_b_value = parseFloat(blueMid);
    bluetrack_c_value = parseFloat(blueDef);
  }

  updateProbabilities();       // 再計算
  renderRedDiceTracks();       // 表示も更新
  renderBlueDiceTracks();

}


window.addEventListener("message", event => {
  if (event.data === "closeChangeModal") {
    setTimeout(() => {
      closeChangeModal();  // ← display:none の次のフレームで実行
    }, 0);
  }
});

window.addEventListener("message", event => {
  if (event.data === "closeChangeModal2") {
    setTimeout(() => {
      closeChangeModal2();  // ← display:none の次のフレームで実行
    }, 0);
  }
});


// 選手配置変更フォーメーション変更ボタンクリックイベント
  document.getElementById("setformred-button").addEventListener("click", function () {
    
    localStorage.setItem("formteamId", redTeamId);
    localStorage.setItem("formteamRole", "red"); // ← 追加
    openChangeModal2("red");
  });

  document.getElementById("setformblue-button").addEventListener("click", function () {
    
    localStorage.setItem("formteamId", blueTeamId);
    localStorage.setItem("formteamRole", "blue"); // ← 追加
    openChangeModal2("blue");
  });


// 交代ボタンクリックイベント
document.getElementById("changered-button").addEventListener("click", function () {
  openChangeModal("red");
});

document.getElementById("changeblue-button").addEventListener("click", function () {
  openChangeModal("blue");
});



//試合進行情報の保存関数

function saveMatchState() {
  localStorage.setItem("match_turn", turn);
  localStorage.setItem("match_redScore", redScore);
  localStorage.setItem("match_blueScore", blueScore);
  localStorage.setItem("match_isSecondHalfStarted", isSecondHalfStarted);
  localStorage.setItem("match_isExtension", isExtension);
  localStorage.setItem("match_isFirstHalfEnded", isFirstHalfEnded); 
  localStorage.setItem("match_isSideSwapped", isSideSwapped); // ← 追加
}

//試合進行情報の削除関数
function clearMatchState() {
  // formation 情報を削除
  ["red", "blue"].forEach(role => {
    localStorage.removeItem(`formation_${role}_atk`);
    localStorage.removeItem(`formation_${role}_mid`);
    localStorage.removeItem(`formation_${role}_def`);
    localStorage.removeItem(`formation_${role}_positions`);
    localStorage.removeItem(`formation_${role}_changeCount`);
    localStorage.removeItem(`formation_${role}_cumulativeChangeCount`);
  });

  // 試合進行情報を削除
  [
    "match_turn",
    //"match_redScore",
    //"match_blueScore",
    "match_isSecondHalfStarted",
    "match_isExtension",
    "match_isFirstHalfEnded",
    "match_isSideSwapped",
    "match_logs"
  ].forEach(key => localStorage.removeItem(key));

  // 特定パターン（例: changeCount_）にマッチするキーを削除
  Object.keys(localStorage).forEach(key => {
    if (key.startsWith("changeCount_")) {
      localStorage.removeItem(key);
    }
  });

  // 状態変数の初期化（必要であれば）
  isSecondHalfStarted = false;
}





// サイコロカウンター分数宣言
    let redAattempt = 0;  // 試行回数（分母）
    let redAarise = 0; // 成功回数（分子）
    let redBattempt = 0;  // 試行回数（分母）
    let redBarise = 0; // 成功回数（分子）
    let redCattempt = 0;  // 試行回数（分母）
    let redCarise = 0; // 成功回数（分子）
    let blueAattempt = 0;  // 試行回数（分母）
    let blueAarise = 0; // 成功回数（分子）
    let blueBattempt = 0;  // 試行回数（分母）
    let blueBarise = 0; // 成功回数（分子）
    let blueCattempt = 0;  // 試行回数（分母）
    let blueCarise = 0; // 成功回数（分子）

// サイコロのオブジェクト宣言

const allDiceDivs = Array.from(document.querySelectorAll('.dice-square'));

const redDiceDivs = [
  document.querySelector('.d-RedA'),
  document.querySelector('.d-RedB'),
  document.querySelector('.d-RedC')
];

const blueDiceDivs = [
  document.querySelector('.d-BlueA'),
  document.querySelector('.d-BlueB'),
  document.querySelector('.d-BlueC')
];


// 決勝トーナメント画面に戻るボタンイベント
document.getElementById('reset-button').addEventListener('click', () => {
  
//location.reload(); // ページをリロード（新規読み込み）

  clearMatchState(); 

　window.location.href = "knockout_schedule_viewer.html";

});



// 自動モードスタートイベント
document.getElementById('start-button').addEventListener('click', () => {
　
　playBGM(); // ★←追加（BGM再生）

  if (turn <= 1 && !isExtension && !isPK) resetGame();

  if (turn === 46 && isFirstHalfEnded && !isSecondHalfStarted) {
    isSecondHalfStarted = true;
    saveMatchState(); // ← 忘れずに！
  }

  hideModeButtons();

  if (isPK) {
    startAutoPK();
  } else {
    startAutoGame();
  }
});

// 手動モードスタートイベント
document.getElementById('manual-start-button').addEventListener('click', () => {

　playBGM(); // ★←追加（BGM再生）

  if (turn <= 1 && !isExtension && !isPK) resetGame();

  if (turn === 46 && isFirstHalfEnded && !isSecondHalfStarted) {
    isSecondHalfStarted = true;
    saveMatchState();
  }

  if (isPK) {
    pkTurn();
  } else {
    playTurn();
  }

  if (turn !== 46) {
    document.getElementById('setformred-button').style.display = 'none';
    document.getElementById('setformblue-button').style.display = 'none';
  }
});


// 高速モードスタートイベント
document.getElementById('fast-start-button').addEventListener('click', () => {
  if (turn <= 1 && !isExtension && !isPK) resetGame();

  if (turn === 46 && isFirstHalfEnded && !isSecondHalfStarted) {
    isSecondHalfStarted = true;
    saveMatchState();
  }

  if (isPK) {
    fastModePK();
  } else {
    fastModeGame();
  }
});


// ボタンイベント延長戦ボタンイベント
document.getElementById('extension-button').addEventListener('click', () => {
document.getElementById('game-over-message').style.display = 'none';
document.getElementById('extension-button').style.display = 'none';
enterExtension();

});



// 自動モードスタート関数
function startAutoGame() {

  // 選択された速度を取得
  const speedSelect = document.getElementById('speed-select');
  const selectedSpeed = parseFloat(speedSelect.value);  // 例: 1, 0.5, 2

  // 1500ms を基準に速度を計算
  const baseInterval = 1500;
  const interval = baseInterval / selectedSpeed;

gameInterval = setInterval(async () => {
  if (isPaused) return;  // 一時停止中ならスキップ

  const continueGame = await playTurn();
  if (!continueGame) clearInterval(gameInterval);
}, interval);
}


// 自動モードPKスタート関数

function startAutoPK() {

  gameInterval = setInterval(async () => {
    const continueGame = await pkTurn();
    if (!continueGame) clearInterval(gameInterval);
  }, 1500);
}


// 高速モードスタート関数
async function fastModeGame() {
  isFastMode = true;

  hideModeButtons();

  while (true) {
    const continueGame = await playTurn();
    if (!continueGame) break;
  }

  isFastMode = false;  // 終了後は戻しておくと安全
}



// 高速モードPKスタート関数
async function fastModePK() {
  isFastMode = true;
  while (true) {
    const continueGame = await pkTurn();
    if (!continueGame) break;
  }
  isFastMode = false;  // 終了後は戻しておくと安全
}


//非同期処理ミリ秒指定関数
function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }



// ラジオボックス現在位置の更新関数
function updatePositionRadio(pos) {
document.querySelectorAll('input[name="position"]').forEach(radio => {
radio.checked = parseInt(radio.value) === pos;
      });
    }


// 試合時間ターンカウンター更新関数
function updateTurnCounter() {
  let displayTurn = turn;

  if (turn === 46 && isFirstHalfEnded && !isSecondHalfStarted) {
    displayTurn = 45;
  }

  document.getElementById('turn-counter').textContent = `試合時間: ${displayTurn}`;
}



// ログ記録関数
function appendLog(text) {
  gameLogs.push(text);  // ログ配列に追加

  // 表示更新
  const logBox = document.getElementById('game-log');
  logBox.innerHTML += text.replace(/\n/g, "<br>");  // 改行表示に変換
  logBox.scrollTop = logBox.scrollHeight;

  // localStorageに保存
  localStorage.setItem("match_logs", JSON.stringify(gameLogs));
}



// ラジオボックス色の更新関数
function updateRadioColors() {
document.querySelectorAll('input[name="position"]').forEach(radio => {

    // ラジオボックス色の変更
    radio.classList.remove('special');
    radio.classList.remove('special-red');
 
   //特殊モードの条件を満たすときだけ付与する

    if (radio.checked && counterMode==1) {
      radio.classList.add('special');
     }    
    if (radio.checked && counterMode==-1) {
      radio.classList.add('special');
    }
    if (radio.checked && tenseMode==1) {
      radio.classList.add('special');
    }
    if (radio.checked && counterMode==2) {
      radio.classList.add('special-red');
     }  
    if (radio.checked && counterMode==-2) {
      radio.classList.add('special-red');
     }
    if (radio.checked && tenseMode==2) {
      radio.classList.add('special-red');
     }
  });
}



// スマイルマーク更新関数
function updateDiceDots(diceResults, diceDivs) {
  for (let i = 0; i < diceResults.length; i++) {
    const existingDot = diceDivs[i].querySelector('.dot');
    if (existingDot) {
      existingDot.remove();
    }
    if (diceResults[i] === 1) {
      const dot = document.createElement('div');
      dot.classList.add('dot');

      // ニッコリマークの口を追加
      const mouth = document.createElement('span');
      dot.appendChild(mouth);

      diceDivs[i].appendChild(dot);
    }
  }
}



// 自動手動高速モードボタンの表示関数
function showModeButtons() {
  document.getElementById('start-button').style.display = 'inline-block';
  document.getElementById('manual-start-button').style.display = 'inline-block';
  document.getElementById('fast-start-button').style.display = 'inline-block'; 
  document.getElementById('setformred-button').style.display = 'inline-block'; 
  document.getElementById('setformblue-button').style.display = 'inline-block'; 
}

// 自動手動高速モードボタンの非表示関数
function hideModeButtons() {
  document.getElementById('start-button').style.display = 'none';
  document.getElementById('manual-start-button').style.display = 'none';
  document.getElementById('fast-start-button').style.display = 'none'; 
  document.getElementById('setformred-button').style.display = 'none'; 
  document.getElementById('setformblue-button').style.display = 'none'; 
}




// 延長戦条件チェック関数
function checkExtensionCondition() {
  return redScore === blueScore;
}




// 試合終了ポップアップ表示関数
function showGameOverMessage(message) {
  const gameOverMessage = document.getElementById('game-over-message');
  gameOverMessage.textContent = message;
  gameOverMessage.style.display = 'block';
}



// 延長戦ボタン表示関数
function showExtensionButton() {
  const extensionButton = document.getElementById('extension-button');
  extensionButton.style.display = 'block';
}

// PK戦ボタン表示関数
function showPKButton() {
  const pkButton = document.getElementById('pk-button');
  pkButton.style.display = 'block';
}

// 延長戦突入の設定関数
function enterExtension() {
  isExtension = true;
  maxTurns = 120;
  turn = 91;  // 延長開始ターンに設定
  counterMode = 0;   // 特殊モードリセット
  tenseMode =0;
  position = 0;  // 位置だけリセット
  isFastMode = false;  // ←ここを追加！
  updatePositionRadio(position);

  showModeButtons();
  document.getElementById('setformred-button').style.display = 'none'; 
  document.getElementById('setformblue-button').style.display = 'none'; 
  document.getElementById('extension-button').style.display = 'none';
  alert("延長戦開始！！モードを選んで再開してください！");
}

// PK戦突入関数
function enterPK() {
  isPK = true;
  maxTurns = 200;
  turn = 121;  // PK開始ターン
  position = 0;
  updatePositionRadio(position);

  showModeButtons();
  document.getElementById('setformred-button').style.display = 'none'; 
  document.getElementById('setformblue-button').style.display = 'none'; 
  document.getElementById('pk-button').style.display = 'none';
    alert("PK戦開始！！モードを選んで再開してください！");
}

// ゲームリセット関数
function resetGame() {
  position = 0;
  redScore = 0;
  blueScore = 0;
  turn = 1;
  isExtension = false;
  isPK = false;
  isFirstHalfEnded = false;  // ←追加
  isSecondHalfStarted = false;  // ← 忘れずに！
  maxTurns = 90;

  document.getElementById('red-score').textContent = redScore;
  document.getElementById('blue-score').textContent = blueScore;
  document.getElementById('red-goal-message').style.display = 'none';
  document.getElementById('blue-goal-message').style.display = 'none';
  document.getElementById('game-over-message').style.display = 'none';
  document.getElementById('extension-button').style.display = 'none';
  document.getElementById('extension-button').style.display = 'none';
  document.getElementById('game-log').textContent = "";
  updatePositionRadio(position);
  updateTurnCounter();
  if (gameInterval) clearInterval(gameInterval);
}






// ゴールメッセージ表示関数非同期
async function showGoal(pos) {
  const redMsg = document.getElementById('red-goal-message');
  const blueMsg = document.getElementById('blue-goal-message');
  
  // 速度倍率を取得
  const speedSelect = document.getElementById('speed-select');
  const selectedSpeed = parseFloat(speedSelect.value) || 1;
  
  const displayTime = 1200 / selectedSpeed;  // 調整
  
  if (pos >= 3) {
    redMsg.style.display = 'block';
    await sleep(displayTime);
    redMsg.style.display = 'none';
  } else if (pos <= -3) {
    blueMsg.style.display = 'block';
    await sleep(displayTime);
    blueMsg.style.display = 'none';
  }
}



// サイコロアニメーションリセット関数

function clearDiceActive() {
  allDiceDivs.forEach(dice => {
    dice.classList.remove('dice-active');
    void dice.offsetWidth; // ← アニメーションをリセットして再生するため
  });
}

// サイコロアニメーション関数赤
function diceAact(activeRedClasses) {
  redDiceDivs.forEach(dice => {
    activeRedClasses.forEach(cls => {
      if (dice.classList.contains(cls)) {
        dice.classList.add('dice-active');
      }
    });
  });
}

// サイコロアニメーション関数青
function diceBact(activeBlueClasses) {
  blueDiceDivs.forEach(dice => {
    activeBlueClasses.forEach(cls => {
      if (dice.classList.contains(cls)) {
        dice.classList.add('dice-active');
      }
    });
  });
}




// 確率データバー表示関数


function renderRedDiceTracks() {
  const values = [redtrack_a_value, redtrack_b_value, redtrack_c_value];
  const diceIds = ["red-dice-track-a", "red-dice-track-b", "red-dice-track-c"];
  const maxValue = 130;

  diceIds.forEach((id, index) => {
    const container = document.getElementById(id);
    container.innerHTML = "";

    const value = values[index];
    const barWidthPercent = Math.min((value / maxValue) * 100, 100);

    const bar = document.createElement("div");
    bar.style.height = "14px";
    bar.style.width = `${barWidthPercent}%`;
    bar.style.backgroundColor = "red";
    bar.style.border = "1px solid #333";
    bar.style.marginBottom = "5px";
    bar.style.position = "relative";
    bar.title = `値: ${value}`;

    const text = document.createElement("span");
    text.textContent = Math.round(value); // ← 四捨五入
    text.style.position = "absolute";
    text.style.left = "50%";
    text.style.top = "50%";
    text.style.transform = "translate(-50%, -50%)";
    text.style.color = "white";
    text.style.fontSize = "10px";
    text.style.pointerEvents = "none";

    bar.appendChild(text);
    container.appendChild(bar);
  });
}



function renderBlueDiceTracks() {
  const values = [bluetrack_a_value, bluetrack_b_value, bluetrack_c_value];
  const diceIds = ["blue-dice-track-a", "blue-dice-track-b", "blue-dice-track-c"];
  const maxValue = 130;

  diceIds.forEach((id, index) => {
    const container = document.getElementById(id);
    container.innerHTML = "";

    const value = values[index];
    const barWidthPercent = Math.min((value / maxValue) * 100, 100);

    const bar = document.createElement("div");
    bar.style.height = "14px";
    bar.style.width = `${barWidthPercent}%`;
    bar.style.backgroundColor = "blue";
    bar.style.border = "1px solid #333";
    bar.style.marginBottom = "5px";
    bar.style.position = "relative";
    bar.title = `値: ${value}`;

    const text = document.createElement("span");
    text.textContent = Math.round(value); // ← 四捨五入
    text.style.position = "absolute";
    text.style.left = "50%";
    text.style.top = "50%";
    text.style.transform = "translate(-50%, -50%)";
    text.style.color = "white";
    text.style.fontSize = "10px";
    text.style.pointerEvents = "none";

    bar.appendChild(text);
    container.appendChild(bar);
  });
}




//ハーフタイム陣地入れ替え関数

function swapSideColumnsAndReorderDice() {
  // サイドカラムの左右入れ替え
  const fieldRow = document.getElementById('field-row');
  const leftColumn = document.getElementById('left-column');
  const rightColumn = document.getElementById('right-column');

  fieldRow.insertBefore(rightColumn, fieldRow.children[0]);
  fieldRow.appendChild(leftColumn);

  // 赤チームの dice-square を並び替え: A → B → C
  const redRow = document.getElementById('red-dice-row');
  const redSquares = Array.from(redRow.children);
  redSquares.sort((a, b) => {
    return getRedOrder(a) - getRedOrder(b);
  });
  redSquares.forEach(square => redRow.appendChild(square));

  // 青チームの dice-square を並び替え: C → B → A
  const blueRow = document.getElementById('blue-dice-row');
  const blueSquares = Array.from(blueRow.children);
  blueSquares.sort((b, a) => {
    return getBlueOrder(a) - getBlueOrder(b);
  });
  blueSquares.forEach(square => blueRow.appendChild(square));

  console.log("サイドカラムの入れ替えと dice-square の順序変更を完了しました。");
}

function getRedOrder(elem) {
  if (elem.classList.contains('d-RedA')) return 0;
  if (elem.classList.contains('d-RedB')) return 1;
  if (elem.classList.contains('d-RedC')) return 2;
  return 3;
}

function getBlueOrder(elem) {
  if (elem.classList.contains('d-BlueA')) return 0;
  if (elem.classList.contains('d-BlueB')) return 1;
  if (elem.classList.contains('d-BlueC')) return 2;
  return 3;
}

function reversePositionRadios() {
  const box = document.getElementById('position-box');
  const radios = Array.from(box.children);
  // 現在のラジオボタン要素をすべて逆順に追加し直す
  radios.reverse().forEach(radio => {
    box.appendChild(radio);
  });
}





//メインプレーループ実行機能非同期

async function playTurn() {

  // 前半終了のチェック（手動・自動で一度だけ止める）
  if (turn === 46 && !isFastMode && !isSecondHalfStarted && !isFirstHalfEnded)  {
    
    clearDiceActive();
    swapSideColumnsAndReorderDice();  // ← ここで陣地左右入れ替え呼び出し！
    reversePositionRadios();         // ←ラジオボタン逆順
    position=0;
    updatePositionRadio(position);  
    clearInterval(gameInterval);
    showModeButtons();
    alert("前半終了！後半を始めるにはモードを選んでください！");
    //isSecondHalfStarted = true; // ← 次からはこの条件を通らなくなる
    isFirstHalfEnded = true; // ← これで再実行を防ぐ！
    isSideSwapped = true; // ← ここでセット

    saveMatchState(); // 試合の状態情報を保存
    return false;
  }

  if (turn > maxTurns) {
    if (!isExtension && !isPK && checkExtensionCondition()) {
      showExtensionButton();
    } else if (isExtension && checkExtensionCondition()) {
      showPKButton();
    } else {
      if (!isFastMode) playGamesetYell();
      showGameOverMessage(
        isPK
          ? "PK戦終了！"
          : isExtension
            ? "延長戦終了！"
            : "試合終了！"
      );

       clearMatchState(); 
       
    let winner = (redScore > blueScore) ? redTeamId : blueTeamId;
 
    localStorage.setItem("match_redScore", redScore);
    localStorage.setItem("match_blueScore", blueScore);
    localStorage.setItem("match_winner", winner);
    
    document.getElementById("reset-button").style.display = "block";
    
    }
    return false;
  }

   
  if(turn ==46){
    position=0;
    counterMode = null; // 特殊モード解除
    tenseMode = null;  // 特殊モード解除
    backattackMode = null; // 特殊モード解除
    backattackfail = null;
　　updatePositionRadio(position);
  　updateRadioColors();    
    appendLog("位置リセット。\n");
   }


  //ターン数表示関数呼び出し
  updateTurnCounter();

 　　//ログにターン数表示呼び出し
  let log = `=== ターン ${turn} ===\n`;
 
　　//サイコロの目をゼロにリセット 
 let redDiceResults = [0, 0, 0]; 
  let blueDiceResults = [0, 0, 0];


    //サイコロアニメーション呼び出し
  clearDiceActive();

    //以下メインのサイコロふり


 if (counterMode === 1) {
    log += "★カウンターモード中\n";

     redDiceProbabilities = [RedAP, RedBP*0.6, RedCP*1.4];  // 赤A, 赤B, 赤C
     blueDiceProbabilities = [BlueAP, BlueBP*0.6, BlueCP*1.4]; // 青A, 青B, 青C
   
    redDiceResults[0] = Math.random() < redDiceProbabilities[0] ? 1 : 0;
    redAattempt++;
    if (redDiceResults[0]) redAarise++;

    redDiceResults[1] = Math.random() < redDiceProbabilities[1] ? 1 : 0;
    redBattempt++;
    if (redDiceResults[1]) redBarise++;

    blueDiceResults[1] = Math.random() < blueDiceProbabilities[1] ? 1 : 0;
    blueBattempt++;
    if (blueDiceResults[1]) blueBarise++;

    blueDiceResults[2] = Math.random() < blueDiceProbabilities[2] ? 1 : 0;
    blueCattempt++;
    if (blueDiceResults[2]) blueCarise++;


    diceAact(['d-RedA', 'd-RedB']);
    diceBact(['d-BlueB', 'd-BlueC']);


    log += `\n${redTeamJP}攻(${redDiceResults[0]}) ${blueTeamJP}中(${blueDiceResults[1]})`;
    log += `\n${redTeamJP}中(${redDiceResults[1]}) ${blueTeamJP}守(${blueDiceResults[2]})\n`;
　　log += "\n集中攻撃!!!";

     redDiceProbabilities = [RedAP, RedBP, RedCP];  // 赤A, 赤B, 赤C
     blueDiceProbabilities = [BlueAP, BlueBP, BlueCP]; // 青A, 青B, 青C



    if (
   (blueDiceResults[1] === 1 || blueDiceResults[2] === 1) &&
  (redDiceResults[0] === 1 || redDiceResults[1] === 1) &&
  (blueDiceResults[1] + blueDiceResults[2] + redDiceResults[0] + redDiceResults[1] === 2)
    ) {
      counterMode = 2;
      updateRadioColors();
     log += "★超カウンターモード開始！\n";
     if (!isFastMode) playYell();
    }



  } else if (counterMode === 2) {

     log += "【★超カウンターモード中】\n";

     redDiceProbabilities = [RedAP, RedBP*0.6, RedCP*1.4];  // 赤A, 赤B, 赤C
     blueDiceProbabilities = [BlueAP, BlueBP*0.6, BlueCP*1.4]; // 青A, 青B, 青C

    redDiceResults[0] = Math.random() < redDiceProbabilities[0] ? 1 : 0;
    redAattempt++;
    if (redDiceResults[0]) redAarise++;

    redDiceResults[1] = Math.random() < redDiceProbabilities[1] ? 1 : 0;
    redBattempt++;
    if (redDiceResults[1]) redBarise++;

    blueDiceResults[0] = Math.random() < blueDiceProbabilities[0] ? 1 : 0;
    blueAattempt++;
    if (blueDiceResults[0]) blueAarise++;

    blueDiceResults[1] = Math.random() < blueDiceProbabilities[1] ? 1 : 0;
    blueBattempt++;
    if (blueDiceResults[1]) blueBarise++;

    blueDiceResults[2] = Math.random() < blueDiceProbabilities[2] ? 1 : 0;
    blueCattempt++;
    if (blueDiceResults[2]) blueCarise++;


    diceAact(['d-RedA', 'd-RedB']);
    diceBact(['d-BlueA', 'd-BlueB', 'd-BlueC']);


    log += `\n${blueTeamJP}攻(${blueDiceResults[0]})`;
    log += `\n${redTeamJP}攻(${redDiceResults[0]}) ${blueTeamJP}中(${blueDiceResults[1]})`;
    log += `\n${redTeamJP}中(${redDiceResults[1]}) ${blueTeamJP}守(${blueDiceResults[2]})\n`;
　　log += "\n全員守備!!!";
  
    
     redDiceProbabilities = [RedAP, RedBP, RedCP];  // 赤A, 赤B, 赤C
     blueDiceProbabilities = [BlueAP, BlueBP, BlueCP]; // 青A, 青B, 青C
   

} else if (counterMode === -1) {

    log += "★カウンターモード中\n";

     redDiceProbabilities = [RedAP, RedBP*0.6, RedCP*1.4];  // 赤A, 赤B, 赤C
     blueDiceProbabilities = [BlueAP, BlueBP*0.6, BlueCP*1.4]; // 青A, 青B, 青C

    redDiceResults[1] = Math.random() < redDiceProbabilities[1] ? 1 : 0;
    redBattempt++;
    if (redDiceResults[1]) redBarise++;

    redDiceResults[2] = Math.random() < redDiceProbabilities[2] ? 1 : 0;
    redCattempt++;
    if (redDiceResults[2]) redCarise++;

    blueDiceResults[0] = Math.random() < blueDiceProbabilities[0] ? 1 : 0;
    blueAattempt++;
    if (blueDiceResults[0]) blueAarise++;

    blueDiceResults[1] = Math.random() < blueDiceProbabilities[1] ? 1 : 0;
    blueBattempt++;
    if (blueDiceResults[1]) blueBarise++;



    diceAact(['d-RedB', 'd-RedC']);
    diceBact(['d-BlueA', 'd-BlueB']);

    log += `\n${redTeamJP}中(${redDiceResults[1]}) ${blueTeamJP}攻(${blueDiceResults[0]})`;
    log += `\n${redTeamJP}守(${redDiceResults[2]}) ${blueTeamJP}中(${blueDiceResults[1]})\n`;
    log += "\n集中攻撃!!!";


    
     redDiceProbabilities = [RedAP, RedBP, RedCP];  // 赤A, 赤B, 赤C
     blueDiceProbabilities = [BlueAP, BlueBP, BlueCP]; // 青A, 青B, 青C

    if (
       (blueDiceResults[0] === 1 || blueDiceResults[1] === 1) &&
       (redDiceResults[1] === 1 || redDiceResults[2] === 1) &&
       (blueDiceResults[0] + blueDiceResults[1] + redDiceResults[1] + redDiceResults[2] === 2)

    ) {
      counterMode = -2;
      updateRadioColors();
    log += "★超カウンターモード開始！\n";
     if (!isFastMode) playYell();
    }
  

  } else if (counterMode === -2) {

    log += "【★超カウンターモード中】\n";
   
     redDiceProbabilities = [RedAP, RedBP*0.6, RedCP*1.4];  // 赤A, 赤B, 赤C
     blueDiceProbabilities = [BlueAP, BlueBP*0.6, BlueCP*1.4]; // 青A, 青B, 青C

    redDiceResults[0] = Math.random() < redDiceProbabilities[0] ? 1 : 0;
    redAattempt++;
    if (redDiceResults[0]) redAarise++;

    redDiceResults[1] = Math.random() < redDiceProbabilities[1] ? 1 : 0;
    redBattempt++;
    if (redDiceResults[1]) redBarise++;

    redDiceResults[2] = Math.random() < redDiceProbabilities[2] ? 1 : 0;
    redCattempt++;
    if (redDiceResults[2]) redCarise++;

    blueDiceResults[0] = Math.random() < blueDiceProbabilities[0] ? 1 : 0;
    blueAattempt++;
    if (blueDiceResults[0]) blueAarise++;

    blueDiceResults[1] = Math.random() < blueDiceProbabilities[1] ? 1 : 0;
    blueBattempt++;
    if (blueDiceResults[1]) blueBarise++;



    diceAact(['d-RedA', 'd-RedB', 'd-RedC']);
    diceBact(['d-BlueA', 'd-BlueB']);

    log += `\n${redTeamJP}攻(${redDiceResults[0]})`;
    log += `\n${redTeamJP}中(${redDiceResults[1]}) ${blueTeamJP}攻(${blueDiceResults[0]})`;
    log += `\n${redTeamJP}守(${redDiceResults[2]}) ${blueTeamJP}守(${blueDiceResults[1]})\n`;
　　log += "\n全員守備!!!";



     redDiceProbabilities = [RedAP, RedBP, RedCP];  // 赤A, 赤B, 赤C
     blueDiceProbabilities = [BlueAP, BlueBP, BlueCP]; // 青A, 青B, 青C

  } else {

    switch (position) {


      case 1:   

     
 if (lastPosition === 2) { if (backattackfail===1) {
 


               redDiceResults[0] = Math.random() < redDiceProbabilities[0] ? 1 : 0;
               redAattempt++;
               if (redDiceResults[0]) redAarise++;

               blueDiceResults[0] = Math.random() < blueDiceProbabilities[0] ? 1 : 0;
               blueAattempt++;
               if (blueDiceResults[0]) blueAarise++;

               diceAact(['d-RedA']);
               diceBact(['d-BlueA']);

               log += `\n${redTeamJP}攻(${redDiceResults[0]}) ${blueTeamJP}攻(${blueDiceResults[0]})\n`;
               log += "\n中央守備";
 
              if (redDiceResults[0] === blueDiceResults[0]) {
                 position = 0;
                 backattackfail = null;
                 lastPosition = position;
                 log += `\nセンターへ移動！`;
              
                 } else if (redDiceResults[0] === 0 && blueDiceResults[0] === 1) {
                             position = 0;
                             backattackfail = null;
                            lastPosition = position;
                                           }

                 else   {   backattackfail = null;
                            backattackMode = 1;
                            lastPosition = position;
                        } 
       }  
                 

              else {
    
    redDiceResults[1] = Math.random() < redDiceProbabilities[1] ? 1 : 0;
    redBattempt++;
    if (redDiceResults[1]) redBarise++;

    blueDiceResults[0] = Math.random() < blueDiceProbabilities[0] ? 1 : 0;
    blueAattempt++;
    if (blueDiceResults[0]) blueAarise++;

    diceAact(['d-RedB']);
    diceBact(['d-BlueA']);



    log += `\n${redTeamJP}中(${redDiceResults[1]}) ${blueTeamJP}攻(${blueDiceResults[0]})\n`;
    log += "\n中央守備";
 
       if (redDiceResults[1] === blueDiceResults[0]) {
       position = 0;
      lastPosition = position;
       log += `\nセンターへ移動！`;
        } else if (redDiceResults[1] === 0 && blueDiceResults[0] === 1) {
               position = 0;
               lastPosition = position;
                   }
      
        }  
 } else {
    // 青色サイコロCのみ

    blueDiceResults[2] = Math.random() < blueDiceProbabilities[2] ? 1 : 0;
    blueCattempt++;
    if (blueDiceResults[2]) blueCarise++;


    diceBact(['d-BlueC']);

    log += `\n${blueTeamJP}守(${blueDiceResults[2]})\n`;
    lastPosition = position;



　  　if (blueDiceResults[2] == 0) {
        position = 2;
         log += `\n初期守備を通過しゴール前へ移動！\n`;
        } else { 
               log += `\n強固な初期守備！押し返す!`;
                    }
       }
    
break;

        case 2:


     redDiceProbabilities = [RedAP, RedBP*0.6, RedCP*1.4];  // 赤A, 赤B, 赤C
     blueDiceProbabilities = [BlueAP, BlueBP*0.6, BlueCP*1.4]; // 青A, 青B, 青C

   if  (lastPosition !== 2) {

    redDiceResults[0] = Math.random() < redDiceProbabilities[0] ? 1 : 0;
    redAattempt++;
    if (redDiceResults[0]) redAarise++;

    blueDiceResults[2] = Math.random() < blueDiceProbabilities[2] ? 1 : 0;
    blueCattempt++;
    if (blueDiceResults[2]) blueCarise++;


    diceAact(['d-RedA']);
    diceBact(['d-BlueC']);



        log += `\n${redTeamJP}攻(${redDiceResults[0]}) ${blueTeamJP}守(${blueDiceResults[2]})\n`;
        log += `\n${redTeamJP}の初期攻撃`;

       lastPosition = position;

  } else {

    redDiceResults[0] = Math.random() < redDiceProbabilities[0] ? 1 : 0;
    redAattempt++;
    if (redDiceResults[0]) redAarise++;

    blueDiceResults[1] = Math.random() < blueDiceProbabilities[1] ? 1 : 0;
    blueBattempt++;
    if (blueDiceResults[1]) blueBarise++;

    blueDiceResults[2] = Math.random() < blueDiceProbabilities[2] ? 1 : 0;
    blueCattempt++;
    if (blueDiceResults[2]) blueCarise++;



    diceAact(['d-RedA']);
    diceBact(['d-BlueB', 'd-BlueC']);

        log += `\n${redTeamJP}攻(${redDiceResults[0]}) ${blueTeamJP}中(${blueDiceResults[1]})`;
        log += `\n${blueTeamJP}守(${blueDiceResults[2]})\n`;
　　　　log += `\n${redTeamJP}の通常攻撃`;
       lastPosition = position;
}


   if (
  redDiceResults[0] === 1 &&
  (blueDiceResults[1] === 1 || blueDiceResults[2] === 1) &&
  (redDiceResults[0] + blueDiceResults[1] + blueDiceResults[2] === 2)
   ) 
     {
       counterMode = 1;
      updateRadioColors();
      log += "★カウンターモード開始！\n";
      if (!isFastMode) playYell();
    }


  redDiceProbabilities = [RedAP, RedBP, RedCP];  // 赤A, 赤B, 赤C
  blueDiceProbabilities = [BlueAP, BlueBP, BlueCP]; // 青A, 青B, 青C

       break;

        

      case -1:

  if (lastPosition === -2) {  if(backattackfail) {


           // 赤色サイコロA、青色サイコロA

    redDiceResults[0] = Math.random() < redDiceProbabilities[0] ? 1 : 0;
    redAattempt++;
    if (redDiceResults[0]) redAarise++;

    blueDiceResults[0] = Math.random() < blueDiceProbabilities[0] ? 1 : 0;
    blueAattempt++;
    if (blueDiceResults[0]) blueAarise++;

    diceAact(['d-RedA']);
    diceBact(['d-BlueA']);

    log += `\n${redTeamJP}攻(${redDiceResults[0]}) ${blueTeamJP}攻(${blueDiceResults[0]})\n`;
    log += "\n中央守備";

    if (redDiceResults[0] === blueDiceResults[0]) {
    position = 0;
    backattackfail = null;
    lastPosition = position;
    log += `\nセンターへ移動！\n`;

       } else  if (redDiceResults[0] ==1 && blueDiceResults[0] == 0)
                     {
                          position = 0; 
                          backattackfail = null;
                          lastPosition = position;
 
                     }
    
           else {
                   backattackfail = null;
                   backattackMode = -1; 
                   lastPosition = position;
               }  
    
  }
  else
    
       {

       // 赤色サイコロA、青色サイコロB

    redDiceResults[0] = Math.random() < redDiceProbabilities[0] ? 1 : 0;
    redAattempt++;
    if (redDiceResults[0]) redAarise++;

    blueDiceResults[1] = Math.random() < blueDiceProbabilities[1] ? 1 : 0;
    blueBattempt++;
    if (blueDiceResults[1]) blueBarise++;

    diceAact(['d-RedA']);
    diceBact(['d-BlueB']);

    log += `\n${redTeamJP}攻(${redDiceResults[0]}) ${blueTeamJP}中(${blueDiceResults[1]})\n`;
    log += "\n中央守備";

    if (redDiceResults[0] === blueDiceResults[1]) {
    position = 0;
    lastPosition = position;
    
    log += `\nセンターへ移動！\n`;

          } else  if (redDiceResults[0] ==1 && blueDiceResults[1] == 0) {
                                  position = 0; lastPosition = position;
                                   }
   
      }

  }
 else {


   // 赤色サイコロCのみ

    redDiceResults[2] = Math.random() < redDiceProbabilities[2] ? 1 : 0;
    redCattempt++;
    if (redDiceResults[2]) redCarise++;

    diceAact(['d-RedC']);

    log += `\n${redTeamJP}守(${redDiceResults[2]})\n`;

    lastPosition = position;

 if (redDiceResults[2] == 0) {
     position = -2;
    log += `\n初期守備を通過しゴール前へ移動！\n`;
         } else { 
              log += `\n強固な初期守備！押し返す!`;
               }
}
   
  

break;


      case -2:

     redDiceProbabilities = [RedAP, RedBP*0.6, RedCP*1.4];  // 赤A, 赤B, 赤C
     blueDiceProbabilities = [BlueAP, BlueBP*0.6, BlueCP*1.4]; // 青A, 青B, 青C


     if  (lastPosition !== -2) {


    redDiceResults[2] = Math.random() < redDiceProbabilities[2] ? 1 : 0;
    redCattempt++;
    if (redDiceResults[2]) redCarise++;

    blueDiceResults[0] = Math.random() < blueDiceProbabilities[0] ? 1 : 0;
    blueAattempt++;
    if (blueDiceResults[0]) blueAarise++;



    diceAact(['d-RedC']);
    diceBact(['d-BlueA']);

        log += `\n${redTeamJP}守(${redDiceResults[2]}) ${blueTeamJP}攻(${blueDiceResults[0]})\n`;
     　 log += `\n${blueTeamJP}の初期攻撃`;

        lastPosition = position;

   } else {


    redDiceResults[1] = Math.random() < redDiceProbabilities[1] ? 1 : 0;
    redBattempt++;
    if (redDiceResults[1]) redBarise++;

    redDiceResults[2] = Math.random() < redDiceProbabilities[2] ? 1 : 0;
    redCattempt++;
    if (redDiceResults[2]) redCarise++;


    blueDiceResults[0] = Math.random() < blueDiceProbabilities[0] ? 1 : 0;
    blueAattempt++;
    if (blueDiceResults[0]) blueAarise++;


    diceAact(['d-RedB', 'd-RedC']);
    diceBact(['d-BlueA']);

        log += `\n${redTeamJP}中(${redDiceResults[1]}) ${blueTeamJP}攻(${blueDiceResults[0]}) `;
        log += `\n${redTeamJP}守(${redDiceResults[2]}) \n`;
　　　　log += `\n${blueTeamJP}の通常攻撃`;
        lastPosition = position;
}

   if (
  blueDiceResults[0] === 1 &&
  (redDiceResults[1] === 1 || redDiceResults[2] === 1) &&
  (blueDiceResults[0] + redDiceResults[1] + redDiceResults[2] === 2)
   ) 
    {
       counterMode = -1;
      updateRadioColors();
      log += "★カウンターモード開始！\n";
      if (!isFastMode) playYell();

    }

  redDiceProbabilities = [RedAP, RedBP, RedCP];  // 赤A, 赤B, 赤C
  blueDiceProbabilities = [BlueAP, BlueBP, BlueCP]; // 青A, 青B, 青C


        break;


      case 0:
  

  redDiceProbabilities = [RedAP, RedBP*1.4, RedCP*0.6];  // 赤A, 赤B, 赤C
  blueDiceProbabilities = [BlueAP, BlueBP*1.4, BlueCP*0.6]; // 青A, 青B, 青C

      if (tenseMode === 1) {
       log += "★テンションモード中\n";
                  
     }
 
     if(tenseMode === 2) {
       log += "【★超テンションモード中】\n";
                             
     }  

    redDiceResults[2] = Math.random() < redDiceProbabilities[2] ? 1 : 0;
    redCattempt++;
    if (redDiceResults[2]) redCarise++;

    redDiceResults[1] = Math.random() < redDiceProbabilities[1] ? 1 : 0;
    redBattempt++;
    if (redDiceResults[1]) redBarise++;

    blueDiceResults[2] = Math.random() < blueDiceProbabilities[2] ? 1 : 0;
    blueCattempt++;
    if (blueDiceResults[2]) blueCarise++;

    blueDiceResults[1] = Math.random() < blueDiceProbabilities[1] ? 1 : 0;
    blueBattempt++;
    if (blueDiceResults[1]) blueBarise++;
        

    diceAact(['d-RedC', 'd-RedB']);
    diceBact(['d-BlueC', 'd-BlueB']);

        log += `\n${redTeamJP}中(${redDiceResults[1]}) ${blueTeamJP}中(${blueDiceResults[1]})`;
        log += `\n${redTeamJP}守(${redDiceResults[2]}) ${blueTeamJP}守(${blueDiceResults[2]})\n`;
        log += "\nセンターでの攻防";
      　  
　　　lastPosition = position;

  redDiceProbabilities = [RedAP, RedBP, RedCP];  // 赤A, 赤B, 赤C
  blueDiceProbabilities = [BlueAP, BlueBP, BlueCP]; // 青A, 青B, 青C


// テンションモード判定
if (!tenseMode) {
  if (blueDiceResults[2] === 1 && blueDiceResults[1] === 1 &&
      redDiceResults[2] === 1 && redDiceResults[1] === 1) 
   {
    tenseMode = 2;
    updateRadioColors();
    log += "★超テンションモード開始！\n";

  } else if (

  (blueDiceResults[2] === 1 || blueDiceResults[1] === 1) &&
  (redDiceResults[2] === 1 || redDiceResults[1] === 1) &&
  (blueDiceResults[2] + blueDiceResults[1] + redDiceResults[2] + redDiceResults[1] === 2)
) 
   {
    tenseMode = 1;
    updateRadioColors();
    log += "★テンションモード開始！\n";
    if (!isFastMode) playYell();
  }
} 
// else で分岐させる

else if (tenseMode === 1) {
   if (
   (blueDiceResults[2] === 1 || blueDiceResults[1] === 1) &&
  (redDiceResults[2] === 1 || redDiceResults[1] === 1) &&
  (blueDiceResults[2] + blueDiceResults[1] + redDiceResults[2] + redDiceResults[1] === 2)
  )
    {
    tenseMode = 2;
    updateRadioColors();
    log += "★超テンションモード開始！\n";
    if (!isFastMode) playYell();
   }

  
}



break;
        
    }　//swithの閉じ

 }   //elseの閉じ 



// サイコロ分数カウンターの更新呼び出し

const fractions = [
  { selector: '.d-RedA .redAcounter', arise: redAarise, attempt: redAattempt },
  { selector: '.d-RedB .redBcounter', arise: redBarise, attempt: redBattempt },
  { selector: '.d-RedC .redCcounter', arise: redCarise, attempt: redCattempt },
  { selector: '.d-BlueA .blueAcounter', arise: blueAarise, attempt: blueAattempt },
  { selector: '.d-BlueB .blueBcounter', arise: blueBarise, attempt: blueBattempt },
  { selector: '.d-BlueC .blueCcounter', arise: blueCarise, attempt: blueCattempt },
];

fractions.forEach(({ selector, arise, attempt }) => {
  const fractionLabel = document.querySelector(selector);
  fractionLabel.textContent = `${arise} / ${attempt}`;
});




// サイコロスマイルマークの更新呼び出し
   updateDiceDots(redDiceResults, redDiceDivs);
   updateDiceDots(blueDiceResults, blueDiceDivs);





// 位置の移動処理
let redTotal = redDiceResults.reduce((sum, value) => sum + value, 0);
let blueTotal = blueDiceResults.reduce((sum, value) => sum + value, 0);
let difference = redTotal - blueTotal;
let positionChanged = false;
let p = 0;

if (counterMode === 2 || counterMode === -2) {
  p = 3;
} else if ((counterMode === 1 || counterMode === -1) || tenseMode === 2) {
  p = 2;
} else if (tenseMode === 1) {
  p = 1;
} else {
  p = 0;
}

if (difference === 0) {
  log += "\n\n";

} else if (difference > 0) {

  position += difference + p;
  log += `\n${redTeamJP}が${difference + p}進む\n`;
  positionChanged = true;
  counterMode = null;
  tenseMode = null;
  updateRadioColors();

  if (!isFastMode) playYell();


} else {
  position += difference - p; // differenceは負なので--と同じ意味
  log += `\n${blueTeamJP}が${Math.abs(difference) + p}進む\n`;
  positionChanged = true;
  counterMode = null;
  tenseMode = null;
  updateRadioColors();

  if (!isFastMode) playYell();
 
}
   
     
   

updatePositionRadio(position);



 // ゴール判定

if (isPlaying) return;  // 追加: 実行中なら即リターン
  isPlaying = true;       // 追加: 実行開始時にロック
  
  try {
 
  if (position >= 3 || position <= -3) {
    
    if (!isFastMode) playGoalSE(); // ★←追加：ゴール効果音再生
　　　
    log += "\n■■■■■ ゴール!■■■■■\n";
    appendLog(log);
    
    if (!isFastMode) await showGoal(position);
    if (position >= 3) {
      redScore++;
      appendLog(`${redTeamJP}に1点。位置リセット。\n`);
    } else {
      blueScore++;
      appendLog(`${blueTeamJP}に1点。位置リセット。\n`);
    }
    position = 0;
    backattackMode = null;
    updatePositionRadio(position);
    document.getElementById('red-score').textContent = redScore;
    document.getElementById('blue-score').textContent = blueScore;
 
  } else {
    log += `\n現在位置: ${position}\n${redTeamJP}の得点: ${redScore}\n ${blueTeamJP}の得点: ${blueScore}\n\n`;
    appendLog(log);
  }
   
   } finally {
    isPlaying = false;  // 追加: 実行終了時に解除
   }

  


  turn++;

  return true;  // 継続
}




  //ＰＫ戦関数

async function pkTurn() {


  updateTurnCounter();

  // ログにターン数表示 
  log = `\n=== PK戦 ターン ${turn} ===\n`;

  // サイコロの目をゼロにリセット 
  let redDiceResults = [0, 0, 0];
  let blueDiceResults = [0, 0, 0];

  
  //特殊モードリセット
  tenseMode = 0;
  counterMode = 0;
  backattackMode = null;

  clearDiceActive();


    //奇数ターンからスタート

  if (turn % 2 !== 0) {

    redDiceResults[2] = Math.random() < redDiceProbabilities[2] ? 1 : 0;
    redBattempt++;
    if (redDiceResults[2]) redBarise++;

    blueDiceResults[0] = Math.random() < blueDiceProbabilities[0] ? 1 : 0;
    blueAattempt++;
    if (blueDiceResults[0]) blueAarise++;

    blueDiceResults[1] = Math.random() < blueDiceProbabilities[1] ? 1 : 0;
    blueBattempt++;
    if (blueDiceResults[1]) blueBarise++;

    blueDiceResults[2] = Math.random() < blueDiceProbabilities[2] ? 1 : 0;
    blueCattempt++;
    if (blueDiceResults[2]) blueCarise++;

    diceAact(['d-RedC']);
    diceBact(['d-BlueA', 'd-BlueB', 'd-BlueC']);

    log += `\n${redTeamJP}守(${redDiceResults[2]}) ${blueTeamJP}中(${blueDiceResults[1]})`;
    log += `\n${blueTeamJP}攻(${blueDiceResults[0]}) ${blueTeamJP}守(${blueDiceResults[2]})\n`;

    if (redDiceResults[2] === 1) {
      position++;
      if (!isFastMode) playGoalSE();
      log += `\n${redTeamJP}が止めた！`;
    } else if (blueDiceResults[0] || blueDiceResults[1] || blueDiceResults[2]) {
      position--;
      if (!isFastMode) playGoalSE();
      log += `\n${blueTeamJP}が決めた！`;
    }

  } else {

    redDiceResults[0] = Math.random() < redDiceProbabilities[0] ? 1 : 0;
    redAattempt++;
    if (redDiceResults[0]) redAarise++;

    redDiceResults[1] = Math.random() < redDiceProbabilities[1] ? 1 : 0;
    redBattempt++;
    if (redDiceResults[1]) redBarise++;

    redDiceResults[2] = Math.random() < redDiceProbabilities[2] ? 1 : 0;
    redCattempt++;
    if (redDiceResults[2]) redCarise++;

    blueDiceResults[2] = Math.random() < blueDiceProbabilities[2] ? 1 : 0;
    blueAattempt++;
    if (blueDiceResults[2]) blueAarise++;

    diceAact(['d-RedA', 'd-RedB', 'd-RedC']);
    diceBact(['d-BlueC']);

    log += `\n${redTeamJP}中(${redDiceResults[1]}) ${redTeamJP}攻(${redDiceResults[0]})`;
    log += `\n${redTeamJP}守(${redDiceResults[2]}) ${blueTeamJP}守(${blueDiceResults[2]})\n`;

    if (blueDiceResults[2] === 1) {
      position--;
      if (!isFastMode) playGoalSE();
      log += `\n${blueTeamJP}が止めた！`;
    } else if (redDiceResults[0] || redDiceResults[1] || redDiceResults[2]) {
      position++;
      if (!isFastMode) playGoalSE();
      log += `\n${redTeamJP}が決めた！`;
    }
  }

appendLog(log);


// サイコロ分数カウンターの更新 

const fractions = [
  { selector: '.d-RedA .redAcounter', arise: redAarise, attempt: redAattempt },
  { selector: '.d-RedB .redBcounter', arise: redBarise, attempt: redBattempt },
  { selector: '.d-RedC .redCcounter', arise: redCarise, attempt: redCattempt },
  { selector: '.d-BlueA .blueAcounter', arise: blueAarise, attempt: blueAattempt },
  { selector: '.d-BlueB .blueBcounter', arise: blueBarise, attempt: blueBattempt },
  { selector: '.d-BlueC .blueCcounter', arise: blueCarise, attempt: blueCattempt },
];

fractions.forEach(({ selector, arise, attempt }) => {
  const fractionLabel = document.querySelector(selector);
  fractionLabel.textContent = `${arise} / ${attempt}`;
});

// スマイルマークの更新 
  updateDiceDots(redDiceResults, redDiceDivs);
  updateDiceDots(blueDiceResults, blueDiceDivs);

  updatePositionRadio(position);

  
if (turn % 2 === 0 && position !== 0) {
  showGameOverMessage("PK戦終了！");
  let winner = (position > 0) ? `${redTeamId}` : `${blueTeamId}`;
  let winnerJP = (position > 0) ? `${redTeamJP}` : `${blueTeamJP}`;
  appendLog(`\n最終結果: ${winnerJP}の勝利`);
   if (!isFastMode) playGamesetYell();
   clearMatchState(); 
   
    localStorage.setItem("match_redScore", redScore);
    localStorage.setItem("match_blueScore", blueScore);
    localStorage.setItem("match_winner", winner);
   
   document.getElementById("reset-button").style.display = "block";
   
  return false;
}



  turn++;
  return true;
}

   </script>         
  </body>     
</html>


